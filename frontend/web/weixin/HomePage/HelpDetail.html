<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<script type="text/javascript" src="http://www.zmzfang.com/weixin/js/head.js"></script>
    	<title>芝麻找房</title>
		<link rel="stylesheet" type="text/css" href="../css/mui.min.css" />
		<link rel="stylesheet" type="text/css" href="../css/style.css?v=0.01" />
		<link rel="shortcut icon"  type="image/x-icon" href="../img/favicon.ico">

		<style type="text/css">
			.requirement-info h5{
				padding-left: 15px;
			}
			#bidlist {
				padding-top: 10px;
			}
			.clear {
				clear:left;
			}
			#bid {
				width: 100%;
				border-right: 1px solid #EFEFF4;
				right: 0px;
				left:0px;
				float: left;
				position:relative;
			}
			#sendMsg {
				width: 100%;
				right: 0px;
				left:0px;
				position:relative;
			}
			.no-active {
				background-color:#eeeeff;
			}
			.mui-bar{
				padding:0;
			}
			
			#follow{
				position: absolute;
    			right: 10px;
    			top: 90px;
    			font-size: 12px;
			}
			#favorite{
				color: #FFD306;
			}
			.not-allow{
				color: #999;
			    position: absolute;
			    top: 33px;
			    right: 8px;
			    border: 1px solid #ccc;
			    padding: 6px 8px;
			    font-size: .8rem;
			    cursor: not-allowed;
			    font-weight: 400;
			}
			.allow{
				color: #fff;
			    position: absolute;
			    top: 33px;
			    right: 8px;
			    border: 1px solid #ccc;
			    padding: 6px 8px;
			    font-size: .8rem;
			    cursor: pointer;
			    font-weight: 400;
			    background: #4cd964;
			}
			.head-row{
				padding:0;
				margin:0 1%;
			}
			.head-row .col-xs-2{
				padding-right: 2%;
   				padding-left: 2%;
			}
			.img-responsive{
	    		display: block;
			    max-width: 100%;
			    height: auto;
			}
			.icon {
		       width: 1em; height: 1em;
		       fill: currentColor;
		       overflow: hidden;
		    }
		    .mui-card-footer{
		    	font-size: .9rem;
		    	margin-bottom: 10px
		    }
		    .mui-card-footer .mui-card-link, .mui-card-header .mui-card-link{
		    	height:38px;
		    	line-height: 38px
		    }
		</style>
	</head>

	<body>
        <header class="mui-bar mui-bar-nav">
			<a id="isWechat" class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" href="javascript:void(0)"></a>
			<h1 class="mui-title" id="requirementTitle">求助详情</h1>
			
		</header>
		
		
		<div class="mui-content">
			<div id="needLoginDiv" class="need-login mui-hidden" style="text-align: center; margin-top: 20px;">
				<span style="color: #000; font-size: 1.1rem;">芝麻找房微信端使用说明</span>
				<br />
				
				<div style="width: 45%;margin: auto;margin-top: 10px;">
						<p style="text-align: center;font-size: .85rem;margin-bottom:5px;color:#666;">
						第一步：扫码关注，接收用户联系</br>
					</p>
					<img src="http://www.zmzfang.com/assets/frontend/images/qrcode.jpg" class="img-responsive" alt="/">
				</div>
				<div style="width: 45%;float:left;margin:5px 0 0 10px;">
						<p style="text-align: center;font-size: .85rem;margin-bottom:5px;color:#666;">
						第二步：点击个人中心</br>
					</p>
					<img src="http://www.zmzfang.com/assets/frontend/images/q1.jpg" class="img-responsive" alt="/">
				</div>
				<div style="width: 45%;float:right;margin:5px 10px 0 0px;">
						<p style="text-align: center;font-size: .85rem;margin-bottom:5px;color:#666;">
						第三步：进入用户绑定</br>
					</p>
					<img src="http://www.zmzfang.com/assets/frontend/images/q2.jpg" class="img-responsive" alt="/">
				</div>
					<div style="clear: both;height: 5px;"></div>
				<span>已关注请直接点击</span>
				<br />
				<button type="button" style="margin-top: 5px; margin-bottom:10px;padding: 5px 20px;background-color: #4cd964;color: #fff;">新用户绑定</button>
			</div>
			
			<div id="needWxBrowserDiv" class="need-wxbrower mui-hidden" style="text-align: center; margin-top: 50px;">
				<span style="color: gray; font-size: 0.9em;">请从公众号登陆</span>
				<br />
				<button type="button" class="mui-btn " style="margin-top: 10px; padding: 5px 20px;background-color: #4cd964;color: #fff;">返回主页</button>
			</div>
			
			<div id="displayAfterLoginDiv" class="display-after-login">
				<div id="userInfo" class="card" user-id="1">
					<div class="user-info" style="border-bottom:1px solid #ddd;margin-bottom:20px;">
						<div style="width:42px; height:42px;overflow:hidden;float:left;">
							<img id="userPic" class="circle-img" width="42px" height="42px" data-lazyload-id="0" src="../img/shuijiao.jpg">
						</div>
				       	<div class="user-info-content" style="float:left;margin-left: 0px;padding-left: 10px;">
					        <p class="mui-ellipsis requirement-user-nickname" style="font-size:1.2rem;margin-bottom:5px;"> 
									<span id="userName" ></span>&nbsp;
									<span id="userType" class="mui-hidden" style="font-size:0.3rem;color:green;">经纪人</span>
									<span id="agentIcon" class="mui-icon mui-icon-contact mui-hidden" style="color: royalblue;" ></span>
							</p>
							<p>
								<span>最近登录时间</span> <span id="loginTime"> </span>
								<a id="follow" class="mui-hidden">关注芝麻找房</a>
							</p>
						</div>

				    	<div class="mui-clearfix"></div>
						    <div id="requirementInfo" class="requirement-info" requirement-id="1">
						    	<ul class="row">
						    		<li class="col-xs-12">
						    			<p style="color:#000;font-size:1.1rem;" id="requiremenSubject"></p>
						    		</li>
							        <li class="col-xs-12">
							            <div class="mui-input-row">
							           		<li class="col-xs-12">
								    			<p style="font-weight:700;color:#fc6000;font-size:1.1rem;" id="rewardfee"></p>
									    		<p>详情描述：</p>
												<div>
												    <p id="detail" style="margin-bottom: 10px;text-indent: 1.5rem;color:#000"></p>
												</div>
							           		</li>
											
									        <li class="col-xs-6">
									            <p><span style="color:#999;">发布时间：</span><span id="updatetime"></span></p>
									        </li>
											<li class="col-xs-6">
									            <p><span style="color:#999;">响应时间：</span><span id="level"></span></p>
									        </li>
										</div>
							        </li>
							    </ul>
							    <div class="mui-clearfix"></div>		
							</div>
						</div>	

				<div class="reply-info card">
					<p class="mui-ellipsis" style="font-size:.9rem;color:#000;">
						<svg class="icon" aria-hidden="true">
				            <use xlink:href="#icon-best"></use>
				        </svg>
						最佳回答
					</p>	
					<div id="bestReply">
						<ul class="row">
							<li class="col-xs-12">
								<p style="text-align:center;">暂无最佳评论;</p>
							</li>
						</ul>
					</div>
				</div>
				<div class="reply-otherinfo card">
					<p class="mui-ellipsis" style="font-size:.9rem;color:#000;">
						我来回答
					</p>	
					<div id="pl">
						<div style="width:40px; height:50px;overflow:hidden;float:left;margin-left:10px;margin-right:10px "><img id="myPic" style="width:40px; height:40px; border-radius:100%;" src="" alt="个人头像"></div>
						<p id="myNickname"></p>
						<textarea id="replyDetail" rows="5" placeholder="写下你的评论" style="height:100px;margin: 5px;" ></textarea>
						<button id="publish" type="button" class="mui-btn" style="width: 100px;height: 32px;background-color: #4cd964;color: #fff;">回复求助</button>
					</div>
				</div>
				<div class="reply-otherinfo card">
					<p class="mui-ellipsis" style="font-size:.9rem;color:#000;">
						其他回答
					</p>	
					<div id="otherReply">
						<ul class="row">
							<li class="col-xs-12">
								<p style="text-align:center;">暂无评论;</p>
							</li>
						</ul>
						
					</div>
				</div>
            </div>	
	
		</div>
		<script type="text/javascript" src="http://at.alicdn.com/t/font_7tf8h2djr1rcz0k9.js"></script>
		<script src="../js/mui.min.js" charset="UTF-8"></script>
		<script src="../js/jquery.min.js"></script>
		<script src="../js/ajax.js"></script>
		<script src="../js/dom.create.js"></script>

		<script src="../js/commonAjax.js"></script>
		<script src="../js/requirement.js"></script>
		<script src="../js/user.js"></script>
		<script src="../js/bid.js"></script>
		<script src="../js/loginCheck.js"></script>
		<script src="../js/wxShare.js"></script>
		<script src="../js/common.js"></script>
		<script src = "https://cdn.wilddog.com/sdk/js/2.4.3/wilddog.js"></script>
		<script type="text/javascript" charset="UTF-8">

		    var byId = function(id) {
				return document.getElementById(id);
			};
			getQueryStr('requirementId')
			var userimg = '';
		    var requirementUserId;
		    var loginUser = null;
		    var bidFlag = 0;// 0 表示未投标，1表示用户已经投标
		    var subject;
		    var urlString;
		    var regions;
		    var userId = 0;
		    var helpId = 0;
		    var page = 0;
		    var startSn = 0;
		    //初始化url参数来获取需求id和用户id,如果没有继续执行
		    initUrlParam();
			mui.init({
				swipeBack: false
			});
			
			initLoginUserInfo();
			mui.ready(function() {
				initRequirmentInfo();//不需要登陆

				
				//初始化需求发布人用户信息
				//初始化需求详情信息
				getReplyList();
				
			});
			
			//在头像上增加增加用户信息 tap事件
			document.querySelector('#userPic').addEventListener('tap', function() {
				//用户未登陆，则无法看到
				var userid = $("#userInfo").attr("user-id");
				var type = 1;//1需求页中点击 2 房源页中点击
				var dstUrl = '../Mine/User.html?userId='+userid+'&type='+type;
				
				if(!$('#userType').hasClass('mui-hidden'))
				{
					dstUrl = '../Agent/AgentInfo.html?userId='+userid;
				}
				
				mui.openWindow({
					url: dstUrl,
					id: 'User.html'
				});
			}, false);

			function ready()
			{
				//在头像上增加增加用户信息 tap事件
				$('.content').on('tap', function() {
					//用户未登陆，则无法看到
					var userid = $(this).attr("userId");
					var agentflag = $(this).attr("agentflag");
					var type = 1;//1需求页中点击 2 房源页中点击
					var dstUrl = '../Mine/User.html?userId='+userid+'&type='+type;
					console.log("userid is "+userid);
					if(1 == agentflag)
					{
						dstUrl = '../Agent/AgentInfo.html?userId='+userid;
					}
					
					/**
					if(!$('#userType').hasClass('mui-hidden'))
					{
						dstUrl = '../Agent/AgentInfo.html?userId='+userid;
					}
					**/
					mui.openWindow({
						url: dstUrl,
						id: 'User.html'
					});
				});
			}

			


			//增加url参数处理
			function initUrlParam()
			{
				 urlString = String(window.document.location.href);
				 helpId = getQueryStr("requirementId");
			}


			
			//增加微信分享处理
			function initWxShare(imgsrc)
			{
				var link = 'http://www.zmzfang.com/weixin/HomePage/HelpDetail.html?requirementId='+helpId;
				var imgUrl = imgsrc;
				var param = new Object();
				
				var title = '我要买房，快来约我';
				var desc = '芝麻找房-服务买家的精准找房平台';
				
				// imgUrl = $('userPic').attr('src');
				
				param.title = subject;
				param.desc = desc;
				param.link = link;
				param.imgUrl = imgUrl;
				wxShare(param);
			}
			
			
			//填充需求信息
	        function fillRequiementInfo(data)
	        {
	        	console.log('fillRequiementInfo'+JSON.stringify(data));
	        	var updatetime = data.updatetime;
				updatetime = updatetime.replace(/-/g,'/'); // 将-替换成/，因为下面这个构造函数只支持/分隔的日期字符串
				var date = new Date(updatetime);
				var time = getTimeAgo(date.getTime());
				subject = data.forhelpsubject;
	        	regions = data.regions;
	        	//将他人的需求详情存储到缓存中
	        	var content;

	        	switch(parseInt(data.level)){
	        		case 1:
	        			content="立即";
	        			break;
	        		case 2:
	        			content="一天内";
	        			break;
	        		case 3:
	        			content="一周内";
	        			break;
	        		case 4:
	        			content="一月内";
	        			break;
	        		case 5:
	        			content="三月内";
	        			break;
	        		default:
	        			console.log("data.level is "+data.level);
	        			break;
	        	}
	        					
		        byId("requirementTitle").innerText = subject;
	        	byId("requiremenSubject").innerText = subject;
	        	if(parseInt(data.rewardfee)){
	        		byId("rewardfee").innerText = '红包'+ data.rewardfee+'元';
	        	}
	        	
	        	byId("detail").innerText = data.forhelpdetail;
	        	byId("updatetime").innerText = time;
	        	byId("level").innerText = content;
	        	
	        	userId = data.publishuserid;
	        	requirementUserId = data.publishuserid;
	        	console.log(data.picture);
	        	//获取其他信息成功后，再初始化分享消息
	        	initWxShare(data.picture);
	        	initUserInfo();
	        	if(data.adoptedreplyid){
	        		initBestAnswer();
	        	}
	        }
	        
	        function initUserInfo()
	        {
	        	ajax_get_user_info({
					userid: userId
				});
	        }
	        function initBestAnswer(){
	        	ajax_get_best_reply({'helpid':getQueryStr('requirementId')},getBestReplySuc,getBestReplyFailed);
	        }
	        function getBestReplySuc(data){
	        	console.log('getBestReplySuc'+JSON.stringify(data));
				$('#bestReply').html(fillBestReplyLi(data));
				$('.zan').off('tap',zan);
				$('.cai').off('tap',cai);
				$('.zan').on('tap',zan);
				$('.cai').on('tap',cai);
				ready();
	        }
	        function getBestReplyFailed(){
	        	mui.toast('获取最佳答案失败')
	        }
	        function initRequirmentInfo()
	        {
	        	var reqInfo = new Object();
				reqInfo.helpid = getQueryStr('requirementId');
				reqInfo.userid = null;
				if(loginUser)
				{
					reqInfo.userid = loginUser.id;
				}
				
				// byId("requirementInfo").setAttribute("requirement-id",requirementId);
				ajax_get_help_detail(reqInfo,fillRequiementInfo,getHelpByIdFailed);
			}
			function getHelpByIdFailed(data,options){
				console.log(JSON.stringify(data));
				toastMSG = '获取求助详情失败';
				mui.toast(toastMSG);
			}
	        
	        //填充用户信息
	        function getUserInfoSuccess(data)
	        {
	        	if(data.agentflag=="1"){
	        		//经纪人
	        		//byId("agentIcon").classList.remove("mui-hidden");//暂不显示图像
	        		//byId("userType").innerText = "经纪人";
	        		byId("userType").classList.remove("mui-hidden");
	        	}
	        	userimg = data.picture;
	        	byId("userPic").src = data.picture;
	        	byId("userName").innerText = data.nickname;
	        
	        	var logintime = data.logintime;
				var timearray=logintime.split(" ");
		
	        	byId("loginTime").innerText = timearray[0];
	        	$("#userInfo").attr("user-id",data.id);
	        	
	        }

	        function isUserLogin()
	        {
	        	return true;
	        }
	        
			function getQueryStr(str) {
				var rs = new RegExp("(^|)" + str + "=([^&]*)(&|$)", "gi").exec(urlString), tmp;
				if (tmp = rs) {
				return tmp[2];
				}
				// parameter cannot be found
				return "";
			}
			function initLoginUserInfo(){

				var shareBackUrl = 'http://www.zmzfang.com/weixin/HomePage/index.html';
				 
				loginUser = JSON.parse(localStorage.getItem('zmzfangLoginUserInfo'));
				//console.log('info'+loginUser.wxunionid);
						
				if(loginUser == null || loginUser.wxunionid.length < 1){
					var helpId=getQueryStr('requirementId');
					if(mui.os.wechat){
					   	window.location.href = 'http://www.zmzfang.com/?r=door/scope&view=HomePage/HelpDetail&requirementId='+helpId;
					}
					$('#isWechat').attr('href',shareBackUrl).removeClass('mui-action-back');
					$('#follow').removeClass("mui-hidden");
					$('#myNickname').text('登陆异常');
					$('#follow').on('tap',function(){
						showLoginDiv();
					});
				}else{
					$('#myPic').attr('src',loginUser.picture);
					$('#myNickname').text(loginUser.nickname);
					$('#isWechat').attr('href',shareBackUrl).removeClass('mui-action-back');
					
				}
			}

			//评论
			mui('.reply-otherinfo').on('tap', '#publish', function() {
				
				if(loginUser)
				{
					//没有用户手机号时的处理方式
					var noPhoneRegAfterJumpUrl = 'http://www.zmzfang.com/?r=door/scope&view=HomePage/HelpDetail&requirementId='+helpId;
					var hasPhoneJumpUrl = null;
					checkUserPhone(noPhoneRegAfterJumpUrl,hasPhoneJumpUrl);
				
					if(loginUser.id == $('#userInfo').attr('user-id'))
					{
						mui.toast('您自己发布的需求');
					}
					else if((loginUser.phone && loginUser.phone.length != 11) || (!loginUser.phone))
					{
						mui.toast('请先绑定微信');
					}
					else
					{
						var pubInfo=new Object();
						pubInfo.helpid=getQueryStr('requirementId');
						pubInfo.helpuserid=requirementUserId;
						pubInfo.replyuserid=loginUser.id;
						pubInfo.replydetail=$('#replyDetail').val().trim();
						console.log(pubInfo);
						if(!pubInfo.replydetail)
						{
							mui.toast('答复不能为空');
							return;
						}
						
						if(getByteLen(pubInfo.replydetail) > 150)
						{
							mui.toast('答复长度超过150，超长');
							return;
						}
		
						ajax_add_reply(pubInfo,addReplySuc,addReplyFailed);	        		
					}
				}
				else
				{
					showLoginDiv();
					mui.toast('您还没有绑定微信');
				}
				
				
			});
			
			
			function addReplySuc(data) {
				console.log('回复求助成功'+JSON.stringify(data));
				if(!data.rscode){
					var pubInfo=new Object();
					pubInfo.helpid=getQueryStr('requirementId');
					pubInfo.helpuserid=localStorage.getItem("helpuserid");
					pubInfo.replyuserid=loginUser.id;
					pubInfo.nickname=loginUser.nickname;
					pubInfo.picture=loginUser.picture;
					pubInfo.praisecnt=0;
					pubInfo.negativecnt=0;
					pubInfo.replydetail=$('#replyDetail').val();
					pubInfo.updatetime='刚刚';

					
					var firstFrag ='';
					firstFrag=fillBestReplyLi(pubInfo);
					$('#otherReply').prepend(firstFrag);
					$('.zan').off('tap',zan);
					$('.cai').off('tap',cai);
					$('.zan').on('tap',zan);
					$('.cai').on('tap',cai);
					$("#replyDetail").attr("placeholder","写下你的评论");
					$("#replyDetail").val('');
					sendMsgToUserByWildog();
					mui.toast('发布成功')
					ready();
				}else{
					mui.toast('发布失败,请重试')
				}
				
			}
			function addReplyFailed(data,options){
				console.log(JSON.stringify(data));
				toastMSG = '回复求助失败';
				mui.toast(toastMSG);
			}

			//其他回答
			function getReplyList(){
				ajax_get_reply_list({'helpid':getQueryStr('requirementId')},getReplyListSuc,getReplyListFailed);
			}
			function getReplyListSuc(data) {
				console.log('获取其他答案成功'+JSON.stringify(data));
				
				if(!data){
					return ;
				}

				var firstFrag ='';
				for(var i in data)
				{
					firstFrag +=fillBestReplyLi(data[i]);
				}
				startSn += data.length;
				console.log(startSn);
				
				$('#otherReply').html(firstFrag);
				$('.zan').off('tap',zan);
				$('.cai').off('tap',cai);
				$('.zan').on('tap',zan);
				$('.cai').on('tap',cai);

				ready();
			}
			function getReplyListFailed(data,options){
				console.log(JSON.stringify(data));
				toastMSG = '获取其他答案失败';
				mui.toast(toastMSG);
			}

			//顶踩
			function cai() {
				console.log('cai');
				var pubInfo=new Object();
				pubInfo.replyid=$(this).attr("replyid");
				var cnt = parseInt($(this).text());

				if($(this).hasClass('already')){
					$(this).children('span').text(cnt-1);
					$(this).removeClass('already')
					ajax_del_negative(pubInfo,delNegativeSuc,delNegativeFailed);
				}else{
					$(this).children('span').text(cnt+1);
					$(this).addClass('already')
					ajax_add_negative(pubInfo,delNegativeSuc,delNegativeSuc);
				}
			}
			function addPraiseSuc(data,options){
				console.log('addPraiseSuc'+JSON.stringify(data));
			}
			function addPraiseFailed(data,options){
				console.log('addPraiseFailed'+JSON.stringify(data));
			}
			function delPraiseSuc(data,options){
				console.log('delPraiseSuc'+JSON.stringify(data));
			}
			function delPraiseFailed(data,options){
				console.log('delPraiseFailed'+JSON.stringify(data));
			}


			function zan() {
				console.log('zan');
				var pubInfo=new Object();
				pubInfo.replyid=$(this).attr("replyid");
				var cnt = parseInt($(this).text());
				if($(this).hasClass('already')){
					$(this).children('span').text(cnt-1);
					$(this).removeClass('already')
					ajax_del_praise(pubInfo,delPraiseSuc,delPraiseFailed);
				}else{
					$(this).children('span').text(cnt+1);
					$(this).addClass('already')
					ajax_add_praise(pubInfo,addPraiseSuc,addPraiseFailed);
				}
			}
			function addNegativeSuc(data,options){
				console.log('addNegativeSuc'+JSON.stringify(data));
			}
			function addNegativeFailed(data,options){
				console.log('addNegativeFailed'+JSON.stringify(data));
			}
			function delNegativeSuc(data,options){
				console.log('delNegativeSuc'+JSON.stringify(data));
			}
			function delNegativeFailed(data,options){
				console.log('delNegativeFailed'+JSON.stringify(data));
			}


			function sendMsgToUserByWildog()
			{
				console.log('sendMsgToUserByWildog');
				var loginUser = JSON.parse(localStorage.getItem('zmzfangLoginUserInfo'));
				if(!loginUser)
				{
					console.log('user info not exist');
					return;
				}
				
				var toUserid = $('#userInfo').attr('user-id');
				var toNickname = byId('userName').innerText;
				console.log('toUserid:'+toUserid);
				console.log('toNickName:'+toNickname);
				var fromNickname = loginUser.nickname;
				var now = new Date();
				var content = '「'+fromNickname+'」回复了您的求助 '+subject;
//				content += '时间是：'+ now.toLocaleString();

				var imgsrc=loginUser.picture?loginUser.picture:"http://www.zmzfang.com/weixin/img/favicon.ico";
				var template={"imgsrc":imgsrc ,"title": loginUser.nickname+"的回复","url": "http://www.zmzfang.com/weixin/Mine/MyHelpDetail.html?helpId="+helpId};
				sendSystemMsgToWildog(toUserid,content,template,'zmzs',null);	
			}
			
		</script>
	</body>

</html>