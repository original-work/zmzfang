<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<script type="text/javascript" src="http://www.zmzfang.com/weixin/js/head.js"></script>
    	<title>芝麻找房</title>
		<link rel="stylesheet" type="text/css" href="../css/mui.min.css" />
		<link rel="stylesheet" type="text/css" href="../css/style.css?v=0.01" />
		<link rel="stylesheet" type="text/css" href="../css/image.upload.css" />

		<style type="text/css">	
			#headpic{
				width:110px;
				height:80px;
				overflow:hidden;
				margin-left: 15px;
				margin-top: 15px;
			}
			h5{
				margin:15px 0;
			}
		/*picupload start*/
			/*picupload base*/
			.pick-button{width: 80px;height: 80px;background-image:  url(../img/iconfont-tianjia.png);position:relative;display:inline-block;background-size:80px 80px;}
			.pick-button label{position:absolute;width:80px;height:80px;color:#fff;font-size:2rem;}
			#file{position: absolute;clip: rect(1px 1px 1px 1px);}
			.imgpath{display:inline-block;margin-right:10px;position: relative;}
			.imgpath span{
				display: block;
	    		background-color: transparent;
	    		height:20px;
	    		position:absolute;
	    		bottom:0px;
	    		font-size:.5rem ;
	    		width: 100%;
	    		text-align: center;
	    		color:#fff;
	    	}
	    	/*picupload 进度条*/
	    	.imgpath.active span{
	    		animation:   reverse progress-bar-stripes 0.80s linear infinite;
	    		-webkit-animation: reverse progress-bar-stripes 0.80s linear infinite;
	    		-o-animation: reverse progress-bar-stripes 0.80s linear infinite;
	    		background-image: linear-gradient(
					45deg,
					rgba(255,255,255,.55) 25%,
					transparent 25%,
					transparent 50%,
					rgba(255,255,255,.55) 50%,
					rgba(255,255,255,.55) 75%,
					transparent 75%,
					transparent
				);
				background-image: -webkit-linear-gradient(
					45deg,
					rgba(255,255,255,.55) 25%,
					transparent 25%,
					transparent 50%,
					rgba(255,255,255,.55) 50%,
					rgba(255,255,255,.55) 75%,
					transparent 75%,
					transparent
				);
				background-image: -o-linear-gradient(
					45deg,
					rgba(255,255,255,.55) 25%,
					transparent 25%,
					transparent 50%,
					rgba(255,255,255,.55) 50%,
					rgba(255,255,255,.55) 75%,
					transparent 75%,
					transparent
				);
				background-size: 20px 20px;
			    -webkit-background-size: 20px 20px;
	    	}
	    	@-webkit-keyframes progress-bar-stripes{
				  from{background-position:40px 0}to{background-position:0 0}
			}
			@keyframes progress-bar-stripes{
				  from{background-position:40px 0}to{background-position:0 0}
			}
		/*picupload end*/
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">房源发布</h1>

		</header>

		<div class="mui-content">
			<section id='requirement-info' class="requirement-info">
				<ul id="houseInfoList1" class="mui-table-view">
					<li class="mui-table-view-cell">
						<div class="mui-input-row">
							<p>请继续完善您的房屋资料！信息越详细，您的交易成功率越高</p>

						</div>
					</li>

					<li class="mui-table-view-cell">
						<div class="mui-input-row">
							<label>请选择房龄</label>
							<select id="houseAge" class="mui-btn mui-btn-block" style="float:left;width:50%">
								<option value="item-1">1980</option>
								<option value="item-2">1981</option>
								<option value="item-3">1982</option>
								<option value="item-4">1983</option>
								<option value="item-5">1984</option>
								<option value="item-6">1985</option>
								<option value="item-7">1986</option>
								<option value="item-8">1987</option>
								<option value="item-9">1988</option>
								<option value="item-10">1989</option>
								<option value="item-11">1990</option>
								<option value="item-12">1991</option>
								<option value="item-13">1992</option>
								<option value="item-14">1993</option>
								<option value="item-1">1994</option>
								<option value="item-2">1995</option>	
								<option value="item-10">1996</option>
								<option value="item-11">1997</option>
								<option value="item-12">1998</option>
								<option value="item-13">1999</option>
								<option value="item-14">2000</option>
								<option value="item-1">2001</option>
								<option value="item-3">2002</option>
								<option value="item-4">2003</option>
								<option value="item-5">2004</option>
								<option value="item-6">2005</option>
								<option value="item-7">2006</option>
								<option value="item-8">2007</option>
								<option value="item-9">2008</option>
								<option value="item-10">2009</option>
								<option value="item-11">2010</option>
								<option value="item-12">2011</option>
								<option value="item-13">2012</option>
								<option value="item-14">2013</option>
								<option value="item-15">2014</option>
								<option value="item-16">2015</option>
								<option value="item-16">2016</option>
							</select>
						</div>
					</li>

					<li class="mui-table-view-cell">
						<div class="mui-input-row">
							<label>房屋类型</label>
							<select id="buildingType" class="mui-btn mui-btn-block" style="float:left;width:50%">
								<option value="1">住宅</option>
								<option value="2">商住</option>
								<option value="3">办公</option>
								<option value="4">商铺</option>
							</select>
						</div>
					</li>

					<li class="mui-table-view-cell">
						<div class="mui-input-row">
							<label>装修类型</label>
							<select id="decorationType" class="mui-btn mui-btn-block" style="float:left;width:50%">
								<option value="item-1">毛坯</option>
								<option value="item-2">简装</option>
								<option value="item-3">中装</option>
								<option value="item-4">精装</option>
								<option value="item-5">豪装</option>
							</select>
						</div>
					</li>

					<li class="mui-table-view-cell">
						<div class="mui-input-row">
							<label>房屋朝向</label>
							<select id="orientation" class="mui-btn mui-btn-block" style="float:left;width:50%">
								<option value="item-1">东</option>
								<option value="item-2">南</option>
								<option value="item-3">西</option>
								<option value="item-4">北</option>
								<option value="item-5">东南</option>
								<option value="item-6">西南</option>
								<option value="item-7">东北</option>
								<option value="item-8">西北</option>
							</select>
						</div>
					</li>

					<li class="mui-table-view-cell">
						<div class="mui-input-row">
							<label>具体描述</label>
							<textarea id="detail" rows="5" placeholder="请输入您的具体需求描述" ></textarea>
						</div>
					</li>

					<li class="mui-table-view-cell">
						<div class="mui-input-row mui-checkbox mui-left">
							<label>学区房</label>
							<input id="schoolDistrictFlag" name="checkbox" value="Item 1" type="checkbox">
						</div>
						<div class="mui-input-row mui-checkbox mui-left">
							<label>地铁沿线</label>
							<input id="metroFlag" name="checkbox" value="Item 1" type="checkbox">
						</div>
						<div class="mui-input-row mui-checkbox mui-left">
							<label>满两年</label>
							<input id="ownerOnlyFlag" name="checkbox" value="Item 1" type="checkbox">
						</div>
						<div class="mui-input-row mui-checkbox mui-left">
							<label>满五唯一</label>
							<input id="overFiveOnlyFlag" name="checkbox" value="Item 1" type="checkbox">
						</div>
					</li>
					<!--
					<li class="mui-table-view-cell">
					    <button id='getHousePic' class="mui-btn mui-btn-block" type='button' style="float:center;">选取图片</button>
					</li>  	
					-->
				</ul>
				<div class="mui-input-row" style="padding-left: 20px;">
					<div class="progress">
						<div id="upload">
							<div class="pick-button"> 
								<input id="file" type="file" accept="image/*" />
								<label for="file"></label>
							</div>
						</div>
					</div>
					<h5>最多发布9张</h5>
				</div>
				
				<div id='commitHousePublish' class="submit-btn btn-green">发布房源</div>
			</section>
		</div>

		<script src="../js/mui.min.js" charset="UTF-8"></script>
		<script src="../js/jquery.min.js"></script>
		<script src="../js/ajax.js"></script>
		<script src="../js/common.js"></script>
		<script src="../js/commonAjax.js"></script>
		<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
		
		<script src="../js/PicUpload/dist/lrz.bundle.js"></script>
		<!--<script src="../js/wxShare.js"></script>-->
		<script type="text/javascript" charset="UTF-8">
			var byId = function(id) {
				return document.getElementById(id);
			};
			var user;
			var pic;
			var picname;
			var result = true;
			
			mui.init({
				swipeBack: false
			});
			
			mui.ready(function() {
				var data = localStorage.getItem('zmzfangLoginUserInfo');
				user = JSON.parse(data);
			});
			
			//增加房源发布按钮事件
			document.querySelector('#commitHousePublish').addEventListener('tap', function() {
				console.log('commitHousePublish click');

                //判断用户是否选中了图片 无选中图片 直接发布，有选中图片，则需要上传图片
                if(checkHouseInfo())
                {
                	publishHouseInfo();
                }
                
			}, false);


			//检查房源关键信息
			function checkHouseInfo() {
				if($('#detail').val().trim() == '')
				{
					mui.toast('房源详情不能填空');
					return false;
				}
				return true;
			}

			//上传图片信息
			function uploadPic() {

			}

			function publishHouseInfo() {
				
				var userid = user.id;
				var region = localStorage.getItem("hpublish-region");
				var districtid = localStorage.getItem("hpublish-districtid");
				var districtname = localStorage.getItem("hpublish-districtname");
				var housenumber = localStorage.getItem("hpublish-housenumber");
				var roomnumber = localStorage.getItem("hpublish-roomnumber");
				var buildingarea = localStorage.getItem("hpublish-buildingarea");
				var expectsaleprice = localStorage.getItem("hpublish-expectsaleprice");
				var storey = localStorage.getItem("hpublish-storey");
				var totalstorey = localStorage.getItem("hpublish-totalstorey");
				var roomcnt = localStorage.getItem("hpublish-roomcnt");
				var hallcnt = localStorage.getItem("hpublish-hallcnt");
				var bathroomcnt = localStorage.getItem("hpublish-bathroomcnt");

				var index = byId("houseAge").selectedIndex;
				var houseage = byId("houseAge").options[index].text;

				index = byId("buildingType").selectedIndex;
				var buildingtype = byId("buildingType").options[index].text;

				index = byId("decorationType").selectedIndex;
				var decorationtype = byId("decorationType").options[index].text;
				index = byId("orientation").selectedIndex;
				var orientation = byId("orientation").options[index].text;

				var detail = byId("detail").value;
				console.log('detail:' + detail);

				var schooldistrictflag = "0";
				var metroflag = "0";
				var owneronlyflag = "0";
				var overfiveonlyflag = "0";

				if ($("#schoolDistrictFlag").is(':checked')) {
					schooldistrictflag = "1";
				}

				if ($("#metroFlag").is(':checked')) {
					metroflag = "1";
				}
				if ($("#ownerOnlyFlag").is(':checked')) {
					owneronlyflag = "1";
				}
				if ($("#overFiveOnlyFlag").is(':checked')) {
					overfiveonlyflag = "1";
				}

//              var pictures = new Array();
//				var picCnt = upload.files.length;
//				for(var i=0;i<picCnt;i++)
//				{
//					pictures[i] = {picture:upload.files[i].path.toString(),sn:i.toString()};
//				}
				$("#commitHousePublish").attr("disabled","disabled");
				loadTosever()
				if(!result){
					return;
				}
				
				//var pictures = 'http://www.zmzfang.com/images/house/1500860219415894927.jpg,http://www.zmzfang.com/images/house/15008602191843320292.jpg,http://www.zmzfang.com/images/house/15008602191422492959.jpg';
				var pictures = getUploadStr();
				console.log('pictures:'+pictures);
				var options = {
					mid: getRandStr(20),
					userid: userid,
					region: region,
					districtid: districtid,
					districtname: districtname,
					housenumber: housenumber,
					roomnumber: roomnumber,
					buildingarea: buildingarea,
					expectsaleprice: expectsaleprice,
					storey: storey,
					totalstorey: totalstorey,
					roomcnt: roomcnt,
					hallcnt: hallcnt,
					bathroomcnt: bathroomcnt,
					houseage: houseage,
					buildingtype: buildingtype,
					decorationtype: decorationtype,
					orientation: orientation,
					detail: detail,
					schooldistrictflag: schooldistrictflag,
					metroflag: metroflag,
					owneronlyflag: owneronlyflag,
					overfiveonlyflag: overfiveonlyflag,
					pictures: pictures
				};
				ajax_to_server(addHouseReferralUrl,options,addHouseSuccess,addHouseFail);
			}

			function addHouseSuccess(data) {
				console.log('addHouseSuccess data:'+JSON.stringify(data));
				if(data.rscode !== 0)
				{
					mui.toast('发布房源失败:'+data.error);
					$("#commitHousePublish").removeAttr("disabled");
					return;
				}
			
				var houseid = data.houseid;
				
				toastMSG = '房源发布成功';
				mui.toast(toastMSG);
				var dstUrl = "../Referral/MyHouseDetailReferral.html?houseId="+houseid;
				
				mui.openWindow({
					url: dstUrl
				});
				
			}
			
			function addHouseFail(data)
			{
				var toastMSG = '网络异常，信息提交失败，请重试！';
				mui.toast(toastMSG);
				$("#commitHousePublish").removeAttr("disabled");
			}
			
			//图片上传
			var sn=1;
			$('#file').on('change',function(){
				var imgObj = lrz(this.files[0], {width: 800})
				.then(function (rst) {
					if(getStatus('all').length >= 9){
						mui.toast('图片已超过最大限制');
						$('#file').val('');
						return;
					}
					if(isHad(rst.base64)){
						// console.log(rst.base64);
						mui.toast('该图片已存在，请删除后重试');
						$('#file').val('');
						return;
					}
					var img = new Image();
					img.src = rst.base64;
					img.onload = function () {
						$('#upload').append('<div class="imgpath sn'+sn+'" sn="'+sn+'"><img src="'+rst.base64+'" width="64" height="64" /><span class="percent">准备上传</span ></div>');
						sn++;
						$('.imgpath').off('tap');
						$('.imgpath').on('tap',function(){
							var that = $(this);
							setTimeout(function(){
								that.remove();
							},300)
						})
					};
					$('#file').val('');
				})
			})
			
			function loadTosever(){
				var allFiles = getStatus('unUploaded')
				if(allFiles.length > 0){
					$.ajax({
						url: 'http://www.zmzfang.com/?r=supplyment/house-pic-upload',
						// url: 'http://zm.com/?r=topic/topic-upload',
						data: {base64:allFiles},
						type: 'POST',
						async: false,
						dataType:"json",
						beforeSend: function(){
							$('.imgpath').children('span').addClass('active');
							$('.imgpath').children('span').text('上传中');
						},
						success: function (data) {
							for(i in data){
								if(data[i].status){
									$('.imgpath.sn'+data[i].sn).removeClass('active');
									$('.imgpath.sn'+data[i].sn).addClass('success');
									$('.imgpath.sn'+data[i].sn).children('span').css('background-color','#073');
									$('.imgpath.sn'+data[i].sn).attr('realname',data[i].picname);
									$('.imgpath.sn'+data[i].sn).children('span').text('上传成功');
								}else{
									$('.imgpath.sn'+data[i].sn).removeClass('active');
									$('.imgpath.sn'+data[i].sn).children('span').css('background-color','#c00');
									$('.imgpath.sn'+data[i].sn).children('span').text('上传失败');
								}
							}
							if(getStatus('unUploaded').length == 0){
								mui.toast('图片全部上传成功');
								return;
							}else{
								mui.toast('图片尚未全部上传成功');
								result = false;
								return;
							}
						},
						error: function(jqXHR){
							mui.toast("上传图片发生错误"+ jqXHR.status);
							result = false;
							return;
						}

					});
				}else{
					return;
				}
			}
			function Obj(base64,sn)
			{
				this.base64 = base64;
				this.sn= sn;       
			}
			function getStatus($t){
				var count = $('#upload').children('.imgpath').length;
				var listArray = [];
				switch($t){
					case 'all':
						for(var i=0;i<count;i++ ){
							var listOne = new Obj();
							listOne.base64 = $('#upload').children('.imgpath').eq(i).children('img').attr('src');
							listOne.sn = $('#upload').children('.imgpath').eq(i).attr('sn');
							listArray.push(listOne);
						}
					break;
					case 'unUploaded':
						for(var i=0;i<count;i++ ){
							if($('#upload').children('.imgpath').eq(i).hasClass("success")){
								continue;
							}
							var listOne = new Obj();
							listOne.base64 = $('#upload').children('.imgpath').eq(i).children('img').attr('src');
							listOne.sn = $('#upload').children('.imgpath').eq(i).attr('sn');
							listArray.push(listOne);
						}
					break;
					case 'uploaded':
						for(var i=0;i<count;i++ ){
							if($('#upload').children('.imgpath').eq(i).attr('realname')){
								var listOne = new Obj();
								listOne.base64 = $('#upload').children('.imgpath').eq(i).attr('realname');
								listOne.sn = $('#upload').children('.imgpath').eq(i).attr('sn');
								listArray.push(listOne);
							}
						}
					break;
				}
				return listArray;
			}
			
			function isHad($p){
				var $allpic = getStatus('all');
				for(i in $allpic){
					if($p == $allpic[i]['base64']){
						return true;
					}
				}
				return false;
			}
			function getUploadStr(){
				var a = getStatus('uploaded');
				var arr = [];
				for (i in a){
					arr[i] = a[i].base64;
				}
				return arr.join(",")
			}
		</script>
	</body>

</html>
