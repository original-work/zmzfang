<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<script type="text/javascript" src="http://www.zmzfang.com/weixin/js/head.js"></script>
		<title>芝麻找房</title>
		<link rel="stylesheet" type="text/css" href="../css/mui.min.css" />
		<link rel="stylesheet" type="text/css" href="../css/style.css?v=0.01" />
		<link rel="stylesheet" type="text/css" href="../css/mui.picker.css" />
		<link rel="stylesheet" type="text/css" href="../css/mui.poppicker.css" />
		
		<style type="text/css">
			.mui-scroll-wrapper{
				overflow: inherit;
			}
			
			.mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active {
				/*color: #666;
				border-bottom: 2px solid blue;
				background: 0 0;*/
			}

			.img-responsive{
				display: block;
				max-width: 100%;
				height: auto;
			}
			#subject{
				margin-top: 10px;
				margin-bottom: 10px;
				text-align: center;
				position: relative;
			}
			nav.header-nav{
				padding: .6rem .75rem;
			}
			nav.header-nav a{
				border: 1px solid #ddd;
				padding: .25rem 0;
				width: 4rem;
				display: inline-block;
				color:#999;
				background: #fff;
			}
			nav.header-nav a:first-child{
				border-radius:.3rem 0 0 .3rem;
				border-right: none;
			}
			nav.header-nav a:last-child{
				border-radius:0 .3rem .3rem 0;
				border-left: none;
			}
			nav.header-nav a.current {
				color: #fff;
				background: #4cd964;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">转介求购发布</h1>
			
		</header>
		
		<div class="mui-content">
			<div id="displayAfterLoginDiv">
				<div id="subject">
						<nav class="header-nav">
							<a class="current" href="http://www.zmzfang.com/weixin/Referral/RequirementReferral.html">求购
							<a href="http://www.zmzfang.com/weixin/Referral/HousePublish1.html">发房源</a>
						</nav>
				</div>
			
				<section id='requirement-info' class="requirement-info">
					<ul id="addressInfoList" class="mui-table-view">
						<li class="mui-table-view-cell">
							<div class="mui-input-row">
								<label>区域</label>
								<button id='city' class="mui-btn mui-btn-block" type='button' style="width:60%;float:left">点击选择城市</button>
								<!--<input id="areaName" type="text" placeholder="" disabled="disabled">-->
							</div>
						</li>
						
						<li class="mui-table-view-cell">
							<div class="mui-input-row">
								<label>总价</label>
								<select id="budget">
								  <option value="0-99">100万以内</option>
								  <option value="100-149">100万到150万</option>
								  <option value="150-199">150万到200万</option>
								  <option value="200-299">200万到300万</option>
								  <option value="300-399">300万到400万</option>
								  <option value="400-599">400万到600万</option>
								  <option value="600-799">600万到800万</option>
								  <option value="800-999">800万到1000万</option>
								  <option value="1000-90000">1000万以上</option>
								</select>
							</div>
						</li>
					
						<li class="mui-table-view-cell">
							<div class="mui-input-row">
								<label>户型</label>
								<select id="houseType" class="mui-btn mui-btn-block" style="float:left;width:50%">
									<option value="1">1室</option>
									<option value="2" selected="selected">2室</option>
									<option value="3">3室</option>
									<option value="4">4室</option>
									<option value="5-10">5室及以上</option>
								</select>
							</div>
						</li>
					
						<li class="mui-table-view-cell">
							<div class="mui-input-row">
								<label>楼层</label>
								<select id="storey" class="mui-btn mui-btn-block" style="float:left;width:50%">
									<option value="0-300">不限</option>
									<option value="1-2">1-2楼</option>
									<option value="3-4">3-4楼</option>
									<option value="5-6">5-6楼</option>
									<option value="7-10">7-10楼</option>
									<option value="11-15">11-15楼</option>
									<option value="16-20">16-20楼</option>
									<option value="21-25">21-25楼</option>
									<option value="26-30">26-30楼</option>
									<option value="31-300">30楼以上</option>
								</select>
							</div>
						</li>
					
						<li class="mui-table-view-cell">
							<div class="mui-input-row">
								<label>类型</label>
								<select id="buildingType" class="mui-btn mui-btn-block" style="float:left;width:50%">
									<option value="1">住宅</option>
									<option value="2">商住</option>
									<option value="3">办公</option>
									<option value="4">商铺</option>
								</select>
							</div>
						</li>
					
						<li class="mui-table-view-cell">
							<div class="mui-input-row">
								<label>具体描述</label>
								<textarea id="detail" rows="5" placeholder="请输入您的具体需求描述，合理的需求价格会吸引更多的房源方" ></textarea>
							</div>
						</li>
						
					</ul>
					<div id='commitRequirementPublish' class="submit-btn btn-green">发布需求</div>
					
				</section>
			</div>
		</div>
		

		<script src="../js/mui.min.js" charset="UTF-8"></script>
		<script src="../js/jquery.min.js"></script>
		<script src="../js/auth.js"></script>
		<script src="../js/mui.picker.js"></script>
		<script src="../js/mui.poppicker.js"></script>
		<script src="../js/area.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/common.js"></script>
		<script src="../js/ajax.js"></script>
		<script src="../js/commonAjax.js"></script>
		<script src="../js/city.data.js"></script>
		<script src="../js/wxShare.js"></script>
		
		<script type="text/javascript" charset="UTF-8">

			var byId = function(id) {
				return document.getElementById(id);
			};
			
			var loginUser = null;
			var subject = '';
			mui.init({
				swipeBack: true
			});
			
			//初始化用户信息及检查
			$('.mui-content').Auth({wechat:false})
			
			mui.ready(function() {
				
				//初始化业务城市选择器
				loginUser = JSON.parse(localStorage.getItem('zmzfangLoginUserInfo'));
				initCityPicker();
				
				//初始化微信分享
				wxShare();

			});
			
			// mui.back = function(){
			mui.back = function(){
				mui.openWindow({
					url: '../HomePage/index.html'
				});
			};
			
			document.querySelector('#commitRequirementPublish').addEventListener('tap', addRequirement, false);
		    
			//初始化籍贯按钮
			function initCityPicker()
			{
				//级联示例
				var cityPicker = new mui.PopPicker({
					layer: 2
				});
				//cityPicker.setData(openedCityData);
				cityPicker.setData(cityData);
				var showCityPickerButton = document.getElementById('city');
				
				showCityPickerButton.addEventListener('tap', function(event) {
				
					cityPicker.show(function(items) {
						console.log("你选择的城市是:" + items[0].text);
						showCityPickerButton.innerText = items[0].text + items[1].text;
					
						//返回 false 可以阻止选择框的关闭
						//return false;
					});
				}, false);
			}
			
			function addRequirement()
			{
				console.log('commitRequirementPublish click');
				
				//获取界面输入元素内容
				var publishuserid = loginUser.id;
				var publishusertype = loginUser.agentflag;
				
				var requirementtype = 1;
				var region = $('#city').text();
				subject = region;
				var index = byId("budget").selectedIndex;
				var budget = byId("budget").options[index].value;
				
				index = byId("houseType").selectedIndex;
				console.log('index:'+index);
				//
				var housetype = byId("houseType").options[index].value;
				
				index = byId("storey").selectedIndex;
				var storey = byId("storey").options[index].value;
				
				index = byId("buildingType").selectedIndex;
				var buildingtype = byId("buildingType").options[index].text;
		
				var detail = byId("detail").value;
				
				if(!checkPublishInfo())
				{
					return;
				}
				
				
				$("#commitRequirementPublish").attr("disabled","disabled");
				//removePublishEvent();
				
				var options = {
						publishuserid: publishuserid,
						publishusertype: publishusertype,
						requirementtype: requirementtype,
						region: region,
						subject: subject,
						budget: budget,
						housetype: housetype,
						storey: storey,
						buildingtype: buildingtype,
						detail: detail,
					};
				ajax_to_server(addRequirementReferralUrl,options,addRequirementSuccess,addRequirementFail);
				//ajax_add_requirement();
			}

			function checkPublishInfo()
		    {
		    	var detail = byId("detail").value;
		    	if(detail == null || detail == '')
		    	{
		    		mui.toast("具体描述不能为空，请至少输入5个汉字");
				    return false;
		    	}
		    	var detailLen = getByteLen(detail.trim());
		    	//alert('detailLen:'+detailLen);
		    	if(detailLen < 10)
		    	{
		    		mui.toast("请至少输入5个字符");
				    return false;
		    	}	
		    	if(detailLen > 200)
		    	{
		    		mui.toast("字符超长，限100汉字");
				    return false;
		    	}	

		    	return true;
		    }
		    
		    function addRequirementSuccess(data)
		    {
		    	console.log('data:'+JSON.stringify(data));
		    	if(!data || data.rscode !== 0)
				{
					$("#commitRequirementPublish").removeAttr("disabled");
					mui.toast('发布需求失败:'+data.error);
					return;
				}
				
				
		    	toastMSG = '需求发布成功';
		    	
				var dstUrl = "../Referral/MyRequirementReferral.html?requirementId="+data.requirementid;
				mui.toast(toastMSG);
				mui.openWindow({
					url: dstUrl
				});
				
		    }
		    
		    function addRequirementFail(data)
		    {
		    	$("#commitRequirementPublish").removeAttr("disabled");
		    	console.log('addRequirementFail data:'+JSON.stringify(data));
		    	var toastMSG = '网络异常，需求提交失败，请重试！';
				mui.toast(toastMSG);
				initPublishEvent();
		    }
		</script>
	</body>

</html>