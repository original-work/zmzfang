<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<script type="text/javascript" src="http://www.zmzfang.com/weixin/js/head.js"></script>
    	<title>芝麻找房</title>
		<link rel="stylesheet" type="text/css" href="../css/mui.min.css" />
		<link rel="stylesheet" type="text/css" href="../css/style.css?v=0.01" />
		<link rel="shortcut icon"  type="image/x-icon" href="../img/favicon.ico">
		<style type="text/css">
		    
		    /*hxj*/
			#popup {
				position: absolute;
			    left: 0;
			    top: 0;
			    width: 100%;
			    height: 100%;
			    background: #fff;
			    box-sizing: border-box;
			    overflow: auto;
			    -webkit-overflow-scrolling: touch;
			    -webkit-transition-property: -webkit-transform;
			    transition-property: transform;
			    /*左右*/
			    -webkit-transform: translate3d(-100%,0,0);
			    transform: translate3d(-100%,0,0);
			    -webkit-transition: -webkit-transform .2s ease;
			    transition: transform .2s ease;
			    /*上下*/
			    /*-webkit-transform: translate3d(0,-100%,0);*/
			    /*transform: translate3d(0,-100%,0);*/
			    opacity: 0;
			    z-index: -1;
			}
			#popup.active {
			    -webkit-transform: translate3d(0,0,0);
			    transform: translate3d(0,0,0);
			    opacity: 1;
			    z-index: 999;
			}
			.pub-faces span {
				text-align: center;
				width: 14.28%;
				float: left;
				display: block;
				margin:3px 0;
			}
			@-webkit-keyframes niceIn {
				0% {bottom:10px;opacity: 0;filter: Alpha(opacity=0);-moz-opacity:0;}
				25% {bottom:20px;opacity: 0.5;filter: Alpha(opacity=50);-moz-opacity:0.5;}
				50% {bottom:30px;opacity: 1;filter: Alpha(opacity=100);-moz-opacity:1;}
				75% {bottom:40px;opacity: 0.5;filter: Alpha(opacity=50);-moz-opacity:0.5;}
				100% {bottom:50px;opacity: 0;filter: Alpha(opacity=0);-moz-opacity:0;}
			}
			@keyframes niceIn {
				0% {bottom:10px;opacity: 0;filter: Alpha(opacity=0);-moz-opacity:0;}
				25% {bottom:20px;opacity: 0.5;filter: Alpha(opacity=50);-moz-opacity:0.5;}
				50% {bottom:30px;opacity: 1;filter: Alpha(opacity=100);-moz-opacity:1;}
				75% {bottom:40px;opacity: 0.5;filter: Alpha(opacity=50);-moz-opacity:0.5;}
				100% {bottom:50px;opacity: 0;filter: Alpha(opacity=0);-moz-opacity:0;}
			}
			@-o-keyframes niceIn{
				0% {bottom:10px;opacity: 0;filter: Alpha(opacity=0);-moz-opacity:0;}
				25% {bottom:20px;opacity: 0.5;filter: Alpha(opacity=50);-moz-opacity:0.5;}
				50% {bottom:30px;opacity: 1;filter: Alpha(opacity=100);-moz-opacity:1;}
				75% {bottom:40px;opacity: 0.5;filter: Alpha(opacity=50);-moz-opacity:0.5;}
				100% {bottom:50px;opacity: 0;filter: Alpha(opacity=0);-moz-opacity:0;}
			}
			@-moz-keyframes niceIn{
				0% {bottom:10px;opacity: 0;filter: Alpha(opacity=0);-moz-opacity:0;}
				25% {bottom:20px;opacity: 0.5;filter: Alpha(opacity=50);-moz-opacity:0.5;}
				50% {bottom:30px;opacity: 1;filter: Alpha(opacity=100);-moz-opacity:1;}
				75% {bottom:40px;opacity: 0.5;filter: Alpha(opacity=50);-moz-opacity:0.5;}
				100% {bottom:50px;opacity: 0;filter: Alpha(opacity=0);-moz-opacity:0;}
			}
			.niceIn {
				opacity: 0;
    			filter: Alpha(opacity=0);
   				-moz-opacity:0;
				position: absolute;
				margin-left: -20px;
				bottom: 10px;
				animation: niceIn 0.5s;
                -moz-animation: niceIn 0.5s;
   				-webkit-animation: niceIn 0.5s;
   				-o-animation: niceIn 0.5s;
   				color:#333;			
   			}
   			.dp{
				color: #777;
				text-align: right;
				margin-top:20px;
			}
			.dp .zan,.dp .cai,.dp .pl{
				padding-right:5px;
			}
			html{height:100%;}
			body{min-height:100%;margin:0;padding:0;position:relative;color: #333;font-size: 14px;}

			header{background-color: #ffe4c4;}
			main{padding-bottom:100px;background-color: #bdb76b;}/* main的padding-bottom值要等于或大于footer的height值 */
			footer{position:absolute;bottom:0;width:100%;height:100px;background-color: #ffc0cb;}

			.mui-slider .mui-slider-group .mui-slider-item img{width:auto;}
			.mui-table-view-chevron .mui-table-view-cell{
				padding-right:0;
			}

			#LightBoxWrap{
			position: fixed;
			z-index: 1000;
			top: 0;
			right: 0;
			bottom: 0;
			left: 0;
			-webkit-transition-duration: 400ms;
			transition-duration: 400ms;
			background: rgba(0,0,0,.4);
			display:none;
			width: 100%;
			height: 100%;
		}
		#LightBox{
			/*display: none;*/
			position:relative;
			width: 100%;
			text-align: center;
		}
		#LightBox img{
			background: #fff;
			height:auto;
			max-width: 80%;
			padding:3px;
			border:1px solid #ccc;
		}
		#closeLightBox {
			position:absolute;
			top:-40px;
			right:-40px;
			padding: 40px;
			background: rgba(0,0,0,.3);
			border-radius: 50%
		}
		#closeLightBox:after {
			content: 'X';
			position: absolute;
			top:45px;
			right:50px;
			color:#fff;
		}
		</style>
	</head>

	<body>
        <header class="mui-bar mui-bar-nav" >
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">匿名详情</h1>
		</header>
		
		<div id="pullrefresh" class="mui-content mui-scroll-wrapper">
		<div class="mui-scroll">
			<div class="card">
				<div style=" width:40px; height:40px;  border-radius:20px;border:1px solid #ccc;float:left;"><span id='picture' style="height:40px; line-height:40px; display:block; text-align:center;"></span></div>
				<div style="float:left;padding-left: 10px;overflow:hidden;">
					<p id="author" style="color:#999;"></p>
					<p id="publish-date"></p>
				</div>
				<div style="clear:both;"></div>
				<div id="describe" style="margin:15px 0 0 8px;word-wrap:break-word;word-break:break-all"></div>
				<div id="pics"></div>
			</div>
			<div class="card">
				<h5>
				 <svg class="icon" aria-hidden="true" style=""><use xlink:href="#icon-zan"></use></svg> <span id="zan"></span> &nbsp;|&nbsp; <svg class="icon" aria-hidden="true" style=""><use xlink:href="#icon-cai"></use></svg> <span id="cai"></span> &nbsp;|&nbsp; <svg class="icon" aria-hidden="true" style=""><use xlink:href="#icon-comment"></use></svg> <span id="count"></span></h5>
				<ul id="new" class="mui-table-view mui-table-view-chevron">
				</ul>
			</div>
		</div>
		</div>
		<nav id="mainBar" class="mui-bar mui-bar-tab" style="height:41px">
			<a id="submitPl" class="mui-tab-item-own mui-active" style="padding: 5px 0;border: 0 solid #ccc;background: #5EDA73;text-align: center;width: 80%;margin: 20px auto 0;color:#fff;height:31px">评论话题</a>
		</nav>
		<div id="popup">
		<header class="mui-bar mui-bar-nav">
			<h1 class="mui-title" id="topicTitle">评论话题</h1>
			<a id="submit" class="mui-btn mui-btn-blue mui-btn-link mui-pull-right">发布</a>
		</header>
		
		<div class="mui-content" style="background: #fff;">
			<div class="ui-page">
				<div class="mui-input-row">
					<textarea id="content" rows="5"></textarea>
				</div>
			</div>
			<div class="pub-faces" id="slider">
			</div>
			<div style="text-align: center;">
				<button id="closePopup">取消</button>
			</div>
		</div>
		</div>
		<div class="mui-popup mui-popup-in" style="display: none;"><div class="mui-popup-inner"><div class="mui-popup-title">芝麻找房</div><div class="mui-popup-text">请先取一个昵称吧</div><div class="mui-popup-input"><input type="text" autofocus="" readonly="readonly" placeholder="" id="niname"></div></div><div class="mui-popup-buttons"><span class="mui-popup-button" id="yesName">确定</span><span class="mui-popup-button mui-popup-button-bold" id="heyClick">换一换</span></div></div>
		<div class="mui-popup-backdrop mui-active" style="display: none;"></div>
		<div id="LightBoxWrap"><div id="LightBox"></div><div id="closeLightBox"></div></div>

		<script type="text/javascript" src="http://at.alicdn.com/t/font_7tf8h2djr1rcz0k9.js"></script>
		<script src="../js/mui.min.js" charset="UTF-8"></script>
		<script src="../js/jquery.min.js"></script>
		<script src="../js/wxShare.js"></script>
		<script src="../js/ajax.js"></script>
		<script src="../js/jquery.qqFace.js"></script>
		<script type="text/javascript" src="../js/pinchzoom.js"></script>
		<script type="text/javascript">

			var loginUser = JSON.parse(localStorage.getItem('zmzfangLoginUserInfo'));
			var id;
			var tid;
			var page= 1;
			var end= 0;
			var nickname;
			new RTP.PinchZoom($('#LightBox'), {'use2d':false});
			mui.init({
				swipeBack: false,
				pullRefresh: {
					container: '#pullrefresh',
					// down: {
					// 	callback: pulldownRefresh
					// },
					up: {
						height:50,
						contentrefresh: '正在加载...',
						contentnomore:'没有更多数据了',
						callback: pullupRefresh,
					}
				}
			});
			mui.ready(function() {
				initUrlParam();
				initTopicInfo();
				getTopicCList();
				mui('.mui-slider').slider();
			});
			mui.back = function(){
				mui.openWindow({
					url: './shuoshuo.html'
				});
			};
			function initTopicInfo(){
				$.ajax({
					type:"POST",
					// url:"http://www.zmzfang.com/?r=topic/t-content",
					url:getInterfaceUrl()+"?r=topic/t-content",
					dataType:"json",
					data:{
						tid : tid?tid:1,
						id: id?id:1
					},
					success: function(res){
						$("#author").html(res.data.niname);
						$("#describe").html(replace_em(res.data.describe));
						$("#picture").html(res.data.niname.substr(0,1));
						$("#zan").html(res.data.zan);
						$("#count").html(res.data.count);
						$("#cai").html(res.data.cai);
						$('#publish-date').html(getTimeAgo(res.data.time));
						if(res.data.pics){
							var picArr = res.data.pics.split(',');
							var imgs='';
							for(i in picArr){
								imgs+= '<img class="orgImg"  style="padding:2px;margin-right:5px;border:1px solid #ccc" src ="./pics/'+picArr[i]+'" width="128" height="128" />';
							}
							var picList ='<p style="padding-top:10px;border-top:1px dotted #efefef;text-align:center">'+imgs+'</p>'
						}
						$('#pics').html(picList);
						$('.orgImg').on('tap',function(e){
								var img = $(this).attr('src');
								$('#LightBox').html('<img src="'+img+'" />');
								$('#LightBoxWrap').css({'display':'table'});
								// $('#LightBox').css('-webkit-transform','scale3d(1,1,1) translate3d(0px,0px,0px)');
								e.stopPropagation();
						})
						$('#closeLightBox').on('tap',function(){
								$('#LightBoxWrap').css({'display':'none'});
							})
						wxShare({"title":'匿名消息：'+res.data.describe,"desc":'来芝麻找房，内幕爆料一吐为快',"imgUrl":'http://www.zmzfang.com/assets/frontend/images/logo-common.jpg','link':window.document.location.href});
						if(localStorage.getItem('niname')){
							nickname = localStorage.getItem('niname');
						}else{
							nickname = '匿名';
						}
						$('#topicTitle').append('(<span style="color:#777">'+nickname+'</span>)')
					},
					 error: function(jqXHR){
						mui.toast("发生错误"+ jqXHR.status);
					}
				});
			}
			function getTopicCList(){
				$.ajax({
					type:"POST",
					// url:"http://www.zmzfang.com/?r=topic/plist",
					url:getInterfaceUrl()+"?r=topic/plist",
					dataType:"json",
					data:{
						topic : tid?tid:1,
						id: id?id:1,
						page : page
					},
					success: function(res){
						var topicList='';
						if(res.data.length < 10){
							if(res.data.length == 0){
								if(page == 1){
									$("#new").append('<li class="col-xs-12"><p style="height:1px;margin:10px 0;background:#ddd;"></p></li><li class="col-xs-12" style="text-align:center;color:#999;">暂无评论</li>');
								}
								page++;
								return;
							}
							end = 1;
						}
						
						for (j in res.data){

							topicList+='<li class="mui-table-view-cell mui-media" id="'+res.data[j].id+'"><div id="requirementBrief" class="requirement-brief"><div style=" width:40px; height:40px;  border-radius:20px;border:1px solid #ccc;float:left;"><span style="height::;0px; line-height:40px; display:block; text-align:center;">'+res.data[j].nickname.substr(0,1)+'</span></div><div style="float:left;padding-left: 10px;width:80%;overflow:hidden;"><p class="requirement-subject" style="margin-left: 0px;color:#999;margin-top:10px;">'+res.data[j].nickname+'</p>'+
								'<p class="requirement-subject" style="margin-left: 0px;color:#000;"></p></div></div>'
								+'<div style="clear:both;"></div><div>'+replace_em(res.data[j].describe)+'</div><div><p class="dp"><svg class="icon zan" aria-hidden="true" style="font-size:18px"><use xlink:href="#icon-zan"></use></svg><i>'+res.data[j].zan+'</i></p></div></li>';
								// <p class="publish-date" style="position:absolute;right:3px;">'+getTimeAgo(res.data[j].time)+'</p>
						}
						$("#new").append(topicList);
						$('.zan').off('tap');
						$('.zan').on('tap',{type:'zan'},dp);
						page++;
					},
					 error: function(jqXHR){
						mui.toast("发生错误"+ jqXHR.status);
					}
				});
			}


			function dp(e){
				console.log(e);
				var id = $(this).parent().parent().parent().attr('id');
				console.log(id);
				var dom = $(this).next('i');
				console.log(dom);
				var html = '+1';
				if($(this).parent().hasClass('active')){
					mui.toast('您已点评过了！');
					return;
				}
				$(this).parent().addClass('active');
				$.ajax({
					type:"POST",
					// url:"http://www.zmzfang.com/?r=topic/pldp",
					url:getInterfaceUrl()+"?r=topic/pldp",
					dataType:"json",
					data:{
						id : id,
						type: e.data.type
					},
					success: function(res){
						if(res.code == 1){
							// alert(id+"被"+e.data.type);
							var adddom = dom.after('<span class="niceIn">'+html+'</span>');
							setTimeout(function(){
								dom.siblings('.niceIn').remove();
								var value = dom.text()
								dom.text(parseInt(value)+1);
							},500);
						}
					},
					 error: function(jqXHR){
						mui.toast("点评发生错误"+ jqXHR.status);
					}
				});
			}


			function pullupRefresh() {
				setTimeout(function() {
					mui('#pullrefresh').pullRefresh().endPullupToRefresh(end===1); //参数为true代表没有更多数据了。
					getTopicCList();
				}, 1500);
			}
			$('#submitPl').on('tap',function(){
				$('#popup').addClass('active');
				mui.scrollTo(0,50,function(){$('#content').focus();$('#content').trigger('tap');});
				document.body.style.overflow='hidden';
			});
			$('#closePopup').on('tap',function(){
				$('#popup').removeClass('active');
				document.body.style.overflow='';
			});
			$('#submit').on('tap',function(){
				if($("#content").val().trim() == ''){
					mui.toast('请先填写评论哦')
					return false;
				}

				$('#popup').removeClass('active');
				document.body.style.overflow='';
				if(loginUser){
					userid = loginUser.id;
				}else{
					userid = -1;
				}

				$.ajax({
					type:"POST",
					url:"http://www.zmzfang.com/?r=topic/add-plist",
					url:getInterfaceUrl()+"?r=topic/add-plist",
					dataType:"json",
					data:{
						id : id,
						topic : tid?tid:1,
						userid : userid,
						nickname : nickname,
						describe : $("#content").val()
					},
					success: function(res){
						var lastHtml;
						if(res.code == 1){
							if($('#new').children('li').text() == '暂无评论'){
								$('#new').empty();
							}
							// mui('#pullrefresh').scroll().scrollTo(0,-1085,100);
							mui.toast("发表评论成功！");
							lastHtml =
							'<li class="mui-table-view-cell mui-media"><div id="requirementBrief" class="requirement-brief"><div style=" width:40px; height:40px;  border-radius:20px;border:1px solid #ccc;float:left;"><span style="height:40px; line-height:40px; display:block; text-align:center;">'+nickname.substr(0,1)+'</span></div><div style="float:left;padding-left: 10px;width:80%;overflow:hidden;"><p class="requirement-subject" style="margin-left: 0px;color:#999;margin-top:10px;">'+nickname+'</p>'+
								'<p class="requirement-subject" style="margin-left: 0px;color:#000;"></p></div></div>'
								+'<div style="clear:both;"></div><div style="margin:15px 0 0 8px;word-wrap:break-word;word-break:break-all">'+replace_em($("#content").val())+'</div></li><div style="margin:15px 0 0 250px;word-wrap:break-word;word-break:break-all"><p class="dp"><svg class="icon" aria-hidden="true" style="font-size:18px"><use xlink:href="#icon-zan"></use></svg><i>0</i></p></div></li>';
								// <p class="publish-date" style="position:absolute;right:3px;">刚刚</p>
							$("#new").prepend(lastHtml);
							$('#content').val('');
						}else{
							mui.toast("发表话题失败，请稍后重试！");
						}
					},
					 error: function(jqXHR){
						mui.toast("发表话题发生错误"+ jqXHR.status);
					}
				});
			});


			//替换表情
			function replace_em(str){
				str = str.replace(/\</g,'&lt;');
				str = str.replace(/\>/g,'&gt;');
				str = str.replace(/\n/g,'<br/>');
				str = str.replace(/\[em_([0-9]*)\]/g,'<img src="face/$1.gif" border="0" />');
				return str;
			}
			function getTimeAgo(time){
				var timestamp = Date.parse(new Date());
				// console.log(timestamp);
				var timeago = timestamp/1000 - time;
				// console.log(timeago);
				if (timeago < 20){
					return '刚刚';
				}
				if (timeago < 60){
					return timeago + '秒前';
				}
				if (timeago < 3600){
					return Math.floor(timeago/60) + '分钟前'
				}
				if (timeago < 86400){
					return Math.floor(timeago/3600) + '小时前'
				}
				if (timeago < 604800){
					return Math.floor(timeago/86400) + '天前'
				}
				if (timeago < 31536000){
					return Math.floor(timeago/604800) + '周前'
				}else{
					return '1年前'
				}
			}
			function initUrlParam() {
				tid = 9;
				id = getQueryStr("id");
				if(localStorage.getItem('niname')){
					nickname = localStorage.getItem('niname');
				}else{
					alert('show name')
					$('.mui-popup').show();
					$('.mui-popup-backdrop').show();
					getName();
				}
			}
			function getQueryStr(str) {
				var rs = new RegExp("(^|)" + str + "=([^&]*)(&|$)", "gi").exec(window.document.location.href), tmp;
				if (tmp = rs) {
					return tmp[2];
				}
				// parameter cannot be found
				return "";
			}
			function getName(){
				var firstname=["温柔","狂野","跳跃","战斗","史诗","疯狂","快乐","惊奇","超能","懒散","黄金","迷茫","隐秘","暗夜","华丽","致命","普通","闪亮","善良","奇迹","野蛮","聪明","卑鄙","为了","幸运","恐惧","青铜","沉默","正义","邪恶","笨笨","乖巧","暴躁","阴险","无辜","合体","有钱","行走","认真","沉睡","奔跑","飞翔","郁闷","崭新","无礼","礼貌","民主","和谐","文明","假","打倒"];
				var nameq=["外套","裤子","杯子","牙刷","绅士","青蛙","充电器","拖鞋","猴子","马","痔疮","鸡翅","肘子","鸭脖","牛","肌肉","胃","蛋挞","熊孩子","南瓜","西红柿","河马","工资","男友","女友","路飞","火锅","烤肉","麻雀","啤酒","细胞","豌豆","汪星人","喵星人","香菜","锤子","香蕉","木棍","石头","司机","火星人","辣条","熊猫","蜗牛","鼠","跳跳虎","火柴"]
				var xingxing = firstname[Math.floor(Math.random() * (firstname.length))];
				var mingming = nameq[Math.floor(Math.random() * (nameq.length))];
					if(xingxing == '为了' || xingxing == '打倒'){
					    var lastName = xingxing+mingming
					}else{
					    var lastName = xingxing+"的"+mingming
					}
				$('#niname').val(lastName);
			}
			$('#heyClick').on('tap',function(){
				getName();
			})
			$('#yesName').on('tap',function(){
				nickname = $('#niname').val();
				localStorage.setItem('niname',nickname);
				$('.mui-popup').hide();
				$('.mui-popup-backdrop').hide();
				mui.toast('welcome,'+nickname+'!');
			})
</script>